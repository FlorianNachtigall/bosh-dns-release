#!/bin/bash -exu

# this export is required by the bosh cli; if HOME is unset then "~" will expand to the literal "~"
export HOME=~

export BOSH_BINARY_PATH=/var/vcap/packages/acceptance-tests/bin/bosh
export BOSH_CLIENT=<%= p('bosh_client') %>
export BOSH_CLIENT_SECRET=<%= p('bosh_client_secret') %>
export BOSH_CA_CERT=$(readlink -m /var/vcap/jobs/acceptance-tests/ca.crt)
export BOSH_ENVIRONMENT=<%= p('bosh_environment') %>
export BOSH_DEPLOYMENT=<%= p('bosh_deployment') %>
export BASE_STEMCELL=<%= p('base_stemcell') %>

<% if p('bosh_jumpbox_address') != "" %>
export JUMPBOX_KEY_PATH="/var/vcap/jobs/acceptance-tests/jumpbox.key"
export BOSH_ALL_PROXY="ssh+socks5://<%= p('bosh_jumpbox_user') %>@<%= p('bosh_jumpbox_address') %>?private-key=${JUMPBOX_KEY_PATH}"
<% end %>

export TEST_MANIFEST_NAME="dns-windows"
export NO_RECURSORS_OPS_FILE="no-recursors-configured-windows"
export LOCAL_RECURSOR_OPS_FILE="add-test-dns-nameservers-windows"
export TEST_TARGET_OS="windows"

export TEST_CLOUD_CONFIG_PATH="/tmp/cloud-config.yml"
${BOSH_BINARY_PATH} cloud-config > ${TEST_CLOUD_CONFIG_PATH}

mkdir -p /var/vcap/data/acceptance-tests
cd /var/vcap/data/acceptance-tests
source /var/vcap/packages/golang-1-linux/bosh/runtime.env

mkdir -p $GOPATH/src
cp -R /var/vcap/packages/acceptance-tests/src/bosh-dns $GOPATH/src/

go install bosh-dns/vendor/github.com/onsi/ginkgo/ginkgo

pushd $GOPATH/src/bosh-dns/acceptance_tests
   ginkgo -randomizeAllSpecs -randomizeSuites -race .
popd
